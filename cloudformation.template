{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Parameters" : {
    "applicationName" : {
      "Type" : "String",
      "Default" : "applicationstack"
    }
  },
  "Outputs" : {
    "MyStackName" : {
      "Value" : {
        "Ref" : "AWS::StackName"
      }
    }
  },
  "Resources" : {
    "ImageRepository" : {
      "Type" : "AWS::ECR::Repository",
      "Properties" : {
        "RepositoryName" : {
          "Ref" : "applicationName"
        },
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Description" : "ALB VPC",
      "Properties" : {
        "CidrBlock" : "10.0.0.0/16",
        "EnableDnsHostnames" : "true",
        "EnableDnsSupport" : "true",
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "internetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "elasticIP" : {
      "Type" : "AWS::EC2::EIP",
      "Properties" : {
        "Domain" : "vpc"
      }
    },
    "nat" : {
      "Type" : "AWS::EC2::NatGateway",
      "DependsOn" : "AttachGateway",
      "Properties" : {
        "AllocationId" : {
          "Fn::GetAtt" : [ "elasticIP", "AllocationId" ]
        },
        "SubnetId" : {
          "Ref" : "publicSubnet"
        },
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "AttachGateway" : {
      "Type" : "AWS::EC2::VPCGatewayAttachment",
      "Properties" : {
        "VpcId" : {
          "Ref" : "VPC"
        },
        "InternetGatewayId" : {
          "Ref" : "internetGateway"
        }
      }
    },
    "Subnet1" : {
      "Type" : "AWS::EC2::Subnet",
      "Description" : "ALB VPC",
      "Properties" : {
        "AvailabilityZone" : "eu-west-1a",
        "CidrBlock" : "10.0.0.0/24",
        "VpcId" : {
          "Ref" : "VPC"
        },
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "Subnet2" : {
      "Type" : "AWS::EC2::Subnet",
      "Description" : "ALB VPC",
      "Properties" : {
        "AvailabilityZone" : "eu-west-1b",
        "CidrBlock" : "10.0.1.0/24",
        "VpcId" : {
          "Ref" : "VPC"
        },
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "publicSubnet" : {
      "Type" : "AWS::EC2::Subnet",
      "Description" : "ALB VPC",
      "Properties" : {
        "AvailabilityZone" : "eu-west-1a",
        "CidrBlock" : "10.0.3.0/24",
        "VpcId" : {
          "Ref" : "VPC"
        },
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "routeTablePrivateSubnet" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : {
          "Ref" : "VPC"
        },
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "routeTablePublicSubnet" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : {
          "Ref" : "VPC"
        },
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "routeToInternet" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "internetGateway",
      "Properties" : {
        "RouteTableId" : {
          "Ref" : "routeTablePrivateSubnet"
        },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : {
          "Ref" : "internetGateway"
        }
      }
    },
    "routeToInternetOnPublicSubnet" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "internetGateway",
      "Properties" : {
        "RouteTableId" : {
          "Ref" : "routeTablePublicSubnet"
        },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : {
          "Ref" : "internetGateway"
        }
      }
    },
    "subnet1RouteTableAssocation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : {
          "Ref" : "routeTablePrivateSubnet"
        },
        "SubnetId" : {
          "Ref" : "Subnet1"
        }
      }
    },
    "subnet2RouteTableAssocation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "RouteTableId" : {
          "Ref" : "routeTablePrivateSubnet"
        },
        "SubnetId" : {
          "Ref" : "Subnet2"
        }
      }
    },
    "taskdefinition" : {
      "Type" : "AWS::ECS::TaskDefinition",
      "Properties" : {
        "TaskRoleArn" : "arn:aws:iam::829867751173:role/ecsTaskExecutionRole",
        "ExecutionRoleArn" : "arn:aws:iam::829867751173:role/ecsTaskExecutionRole",
        "RequiresCompatibilities" : [ "FARGATE" ],
        "NetworkMode" : "awsvpc",
        "Cpu" : "256",
        "Memory" : "512",
        "ContainerDefinitions" : [ {
          "Name" : {
            "Ref" : "applicationName"
          },
          "Image" : "829867751173.dkr.ecr.eu-west-1.amazonaws.com/applications/spring-boot-web-jsp:latest",
          "PortMappings" : [ {
            "ContainerPort" : "8080",
            "HostPort" : "8080"
          } ],
          "Essential" : "true",
          "HealthCheck" : {
            "Retries" : "3",
            "Command" : [ "CMD-SHELL", "curl -f http://localhost:8080 || exit 1" ],
            "Timeout" : "60",
            "Interval" : "60"
          },
          "LogConfiguration" : {
            "LogDriver" : "awslogs",
            "Options" : {
              "awslogs-group" : {
                "Ref" : "logGroup"
              },
              "awslogs-region" : "eu-west-1",
              "awslogs-stream-prefix" : "ecs"
            }
          }
        } ],
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "logGroup" : {
      "Type" : "AWS::Logs::LogGroup",
      "Properties" : {
        "LogGroupName" : {
          "Ref" : "applicationName"
        },
        "RetentionInDays" : 14
      }
    },
    "loadBalancer" : {
      "Type" : "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties" : {
        "Name" : "FargateLoadBalancer",
        "SecurityGroups" : [ {
          "Ref" : "loadBalancerSecurityGroup"
        } ],
        "Scheme" : "internet-facing",
        "Subnets" : [ {
          "Ref" : "Subnet1"
        }, {
          "Ref" : "Subnet2"
        } ],
        "Type" : "application",
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "HTTPlistener" : {
      "Type" : "AWS::ElasticLoadBalancingV2::Listener",
      "Properties" : {
        "DefaultActions" : [ {
          "Type" : "forward",
          "TargetGroupArn" : {
            "Ref" : "targetGroup"
          }
        } ],
        "LoadBalancerArn" : {
          "Ref" : "loadBalancer"
        },
        "Port" : 80,
        "Protocol" : "HTTP"
      }
    },
    "targetGroup" : {
      "Type" : "AWS::ElasticLoadBalancingV2::TargetGroup",
      "DependsOn" : "loadBalancer",
      "Properties" : {
        "Port" : "8080",
        "Protocol" : "HTTP",
        "VpcId" : {
          "Ref" : "VPC"
        },
        "Name" : {
          "Ref" : "applicationName"
        },
        "TargetType" : "ip",
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "loadBalancerSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Load Balancer Security Group",
        "GroupName" : "loadBalancerSecurityGroup",
        "SecurityGroupIngress" : [ {
          "CidrIp" : "0.0.0.0/0",
          "FromPort" : 80,
          "IpProtocol" : "TCP",
          "ToPort" : 80
        } ],
        "VpcId" : {
          "Ref" : "VPC"
        },
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "serviceSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Service security group",
        "GroupName" : "serviceSecurityGroup",
        "SecurityGroupIngress" : [ {
          "CidrIp" : "0.0.0.0/0",
          "FromPort" : 8080,
          "IpProtocol" : "TCP",
          "ToPort" : 8080
        } ],
        "SecurityGroupEgress" : [ {
          "CidrIp" : "0.0.0.0/0",
          "FromPort" : 0,
          "ToPort" : 65535,
          "IpProtocol" : "TCP"
        } ],
        "VpcId" : {
          "Ref" : "VPC"
        },
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "cluster" : {
      "Type" : "AWS::ECS::Cluster",
      "Properties" : {
        "ClusterName" : {
          "Ref" : "applicationName"
        },
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    },
    "service" : {
      "Type" : "AWS::ECS::Service",
      "Properties" : {
        "LaunchType" : "FARGATE",
        "Cluster" : {
          "Ref" : "cluster"
        },
        "DesiredCount" : "1",
        "TaskDefinition" : {
          "Ref" : "taskdefinition"
        },
        "LoadBalancers" : [ {
          "ContainerName" : {
            "Ref" : "applicationName"
          },
          "ContainerPort" : 8080,
          "TargetGroupArn" : {
            "Ref" : "targetGroup"
          }
        } ],
        "NetworkConfiguration" : {
          "AwsvpcConfiguration" : {
            "Subnets" : [ {
              "Ref" : "Subnet1"
            }, {
              "Ref" : "Subnet2"
            } ],
            "SecurityGroups" : [ {
              "Ref" : "serviceSecurityGroup"
            } ],
            "AssignPublicIp" : "ENABLED"
          }
        },
        "Tags" : [ {
          "Key" : "Name",
          "Value" : {
            "Ref" : "applicationName"
          }
        } ]
      }
    }
  }
}